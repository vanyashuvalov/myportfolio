<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Critical Fixes Test - Ivan Shuvalov Portfolio</title>
  
  <link rel="stylesheet" href="styles/reset.css">
  <link rel="stylesheet" href="styles/variables.css">
  <link rel="stylesheet" href="styles/base.css">
  <link rel="stylesheet" href="styles/components.css">
  <link rel="stylesheet" href="styles/widget-error.css">
  
  <style>
    body {
      padding: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .test-section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .test-section h2 {
      margin: 0 0 16px 0;
      color: #101828;
      font-size: 20px;
      font-weight: 600;
    }
    
    .test-section p {
      margin: 0 0 12px 0;
      color: #475467;
      line-height: 1.5;
    }
    
    .test-button {
      background: #3B82F6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    
    .test-button:hover {
      background: #2563EB;
    }
    
    .test-result {
      margin-top: 12px;
      padding: 12px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 13px;
      display: none;
    }
    
    .test-result.success {
      background: #D1FAE5;
      color: #065F46;
      border: 1px solid #10B981;
      display: block;
    }
    
    .test-result.error {
      background: #FEE2E2;
      color: #991B1B;
      border: 1px solid #EF4444;
      display: block;
    }
    
    .test-result.info {
      background: #DBEAFE;
      color: #1E40AF;
      border: 1px solid #3B82F6;
      display: block;
    }
    
    .widget-test-area {
      position: relative;
      min-height: 300px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      margin-top: 16px;
      padding: 20px;
    }
    
    .console-output {
      background: #1F2937;
      color: #10B981;
      padding: 12px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 12px;
    }
    
    .console-output div {
      margin-bottom: 4px;
    }
    
    .console-output .warn {
      color: #F59E0B;
    }
    
    .console-output .error {
      color: #EF4444;
    }
  </style>
</head>
<body>
  <div class="test-section">
    <h2>üîß Critical Fixes Test Suite</h2>
    <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –§–∞–∑—ã 1: CRITICAL</p>
  </div>

  <!-- Test 1: Desktop Canvas Duplication Fix -->
  <div class="test-section">
    <h2>Test 1: Desktop Canvas - –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞</h2>
    <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ workspace container —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑</p>
    <button class="test-button" onclick="testDesktopCanvasDuplication()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
    <div id="test1-result" class="test-result"></div>
    <div id="test1-console" class="console-output" style="display: none;"></div>
  </div>

  <!-- Test 2: Deprecated Methods Warning -->
  <div class="test-section">
    <h2>Test 2: WidgetBase - Deprecated –º–µ—Ç–æ–¥—ã</h2>
    <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ deprecated –º–µ—Ç–æ–¥—ã –≤—ã–¥–∞—é—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</p>
    <button class="test-button" onclick="testDeprecatedMethods()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
    <div id="test2-result" class="test-result"></div>
    <div id="test2-console" class="console-output" style="display: none;"></div>
  </div>

  <!-- Test 3: Error Boundary -->
  <div class="test-section">
    <h2>Test 3: Widget Error Boundary</h2>
    <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤–∏–¥–∂–µ—Ç—ã —Å –æ—à–∏–±–∫–∞–º–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç fallback UI</p>
    <button class="test-button" onclick="testErrorBoundary()">–°–æ–∑–¥–∞—Ç—å –≤–∏–¥–∂–µ—Ç —Å –æ—à–∏–±–∫–æ–π</button>
    <button class="test-button" onclick="clearTestArea()">–û—á–∏—Å—Ç–∏—Ç—å</button>
    <div id="test3-result" class="test-result"></div>
    <div class="widget-test-area" id="error-widget-area"></div>
  </div>

  <!-- Test 4: Memory Leaks Fix -->
  <div class="test-section">
    <h2>Test 4: SimpleDragHover - Memory Leaks</h2>
    <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ event listeners –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—á–∏—â–∞—é—Ç—Å—è</p>
    <button class="test-button" onclick="testMemoryLeaks()">–°–æ–∑–¥–∞—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å 10 –≤–∏–¥–∂–µ—Ç–æ–≤</button>
    <div id="test4-result" class="test-result"></div>
    <div id="test4-console" class="console-output" style="display: none;"></div>
  </div>

  <!-- Test 5: Configurable Boundary Offset -->
  <div class="test-section">
    <h2>Test 5: SimpleDragHover - Configurable Boundary</h2>
    <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ boundary offset –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å</p>
    <button class="test-button" onclick="testConfigurableBoundary()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
    <div id="test5-result" class="test-result"></div>
    <div id="test5-console" class="console-output" style="display: none;"></div>
  </div>

  <script type="module">
    import { DesktopCanvas } from './js/features/desktop-canvas/desktop-canvas.js';
    import { WidgetBase } from './js/entities/widget/widget-base.js';
    import { SimpleDragHover } from './js/shared/lib/simple-drag-hover.js';
    import { EventBus } from './js/shared/utils/event-bus.js';

    // Make available globally for tests
    window.DesktopCanvas = DesktopCanvas;
    window.WidgetBase = WidgetBase;
    window.SimpleDragHover = SimpleDragHover;
    window.EventBus = EventBus;

    console.log('‚úÖ Test modules loaded successfully');
  </script>

  <script>
    // Test 1: Desktop Canvas Duplication
    function testDesktopCanvasDuplication() {
      const result = document.getElementById('test1-result');
      const consoleOutput = document.getElementById('test1-console');
      
      try {
        // Create temporary container
        const container = document.createElement('div');
        container.id = 'test-canvas';
        document.body.appendChild(container);
        
        // Create canvas
        const canvas = new window.DesktopCanvas(container, {
          eventBus: new window.EventBus()
        });
        
        // Check workspace container count
        const workspaceContainers = container.querySelectorAll('.workspace-container');
        
        if (workspaceContainers.length === 1) {
          result.className = 'test-result success';
          result.textContent = `‚úÖ PASS: Workspace container —Å–æ–∑–¥–∞–Ω —Ä–æ–≤–Ω–æ 1 —Ä–∞–∑ (–Ω–∞–π–¥–µ–Ω–æ: ${workspaceContainers.length})`;
        } else {
          result.className = 'test-result error';
          result.textContent = `‚ùå FAIL: –ù–∞–π–¥–µ–Ω–æ ${workspaceContainers.length} workspace containers (–æ–∂–∏–¥–∞–ª–æ—Å—å: 1)`;
        }
        
        // Cleanup
        canvas.destroy();
        container.remove();
        
      } catch (error) {
        result.className = 'test-result error';
        result.textContent = `‚ùå ERROR: ${error.message}`;
        consoleOutput.style.display = 'block';
        consoleOutput.innerHTML = `<div class="error">${error.stack}</div>`;
      }
    }

    // Test 2: Deprecated Methods
    function testDeprecatedMethods() {
      const result = document.getElementById('test2-result');
      const consoleOutput = document.getElementById('test2-console');
      consoleOutput.style.display = 'block';
      consoleOutput.innerHTML = '';
      
      // Capture console.warn
      const originalWarn = console.warn;
      const warnings = [];
      console.warn = function(...args) {
        warnings.push(args.join(' '));
        consoleOutput.innerHTML += `<div class="warn">‚ö†Ô∏è ${args.join(' ')}</div>`;
        originalWarn.apply(console, args);
      };
      
      try {
        // Create test widget
        const element = document.createElement('div');
        const widget = new window.WidgetBase(element, {
          type: 'test',
          eventBus: new window.EventBus()
        });
        
        // Call deprecated methods
        widget.updateTransform();
        widget.getHoverRotation();
        widget.getInteractionScale();
        
        // Restore console.warn
        console.warn = originalWarn;
        
        if (warnings.length === 3) {
          result.className = 'test-result success';
          result.textContent = `‚úÖ PASS: –í—Å–µ 3 deprecated –º–µ—Ç–æ–¥–∞ –≤—ã–¥–∞–ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è`;
        } else {
          result.className = 'test-result error';
          result.textContent = `‚ùå FAIL: –ü–æ–ª—É—á–µ–Ω–æ ${warnings.length} –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π (–æ–∂–∏–¥–∞–ª–æ—Å—å: 3)`;
        }
        
        // Cleanup
        widget.destroy();
        
      } catch (error) {
        console.warn = originalWarn;
        result.className = 'test-result error';
        result.textContent = `‚ùå ERROR: ${error.message}`;
        consoleOutput.innerHTML += `<div class="error">${error.stack}</div>`;
      }
    }

    // Test 3: Error Boundary
    function testErrorBoundary() {
      const result = document.getElementById('test3-result');
      const area = document.getElementById('error-widget-area');
      area.innerHTML = '';
      
      try {
        // Create widget that will fail
        class BrokenWidget extends window.WidgetBase {
          constructor(element, options) {
            super(element, options);
          }
          
          setupElement() {
            // Intentionally throw error
            throw new Error('Simulated widget initialization error');
          }
        }
        
        const element = document.createElement('div');
        area.appendChild(element);
        
        try {
          const widget = new BrokenWidget(element, {
            type: 'broken',
            eventBus: new window.EventBus()
          });
        } catch (e) {
          // Expected error
        }
        
        // Check if error UI is shown
        const hasErrorClass = element.classList.contains('widget--error');
        const hasErrorMessage = element.textContent.includes('Widget failed to load');
        
        if (hasErrorClass && hasErrorMessage) {
          result.className = 'test-result success';
          result.textContent = '‚úÖ PASS: Error boundary –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç fallback UI';
        } else {
          result.className = 'test-result error';
          result.textContent = `‚ùå FAIL: Error UI –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è (hasErrorClass: ${hasErrorClass}, hasErrorMessage: ${hasErrorMessage})`;
        }
        
      } catch (error) {
        result.className = 'test-result error';
        result.textContent = `‚ùå ERROR: ${error.message}`;
      }
    }

    function clearTestArea() {
      document.getElementById('error-widget-area').innerHTML = '';
      document.getElementById('test3-result').style.display = 'none';
    }

    // Test 4: Memory Leaks
    function testMemoryLeaks() {
      const result = document.getElementById('test4-result');
      const consoleOutput = document.getElementById('test4-console');
      consoleOutput.style.display = 'block';
      consoleOutput.innerHTML = '';
      
      try {
        const dragHover = new window.SimpleDragHover();
        const widgets = [];
        
        // Create 10 widgets
        for (let i = 0; i < 10; i++) {
          const element = document.createElement('div');
          document.body.appendChild(element);
          
          const widget = new window.WidgetBase(element, {
            type: 'test',
            eventBus: new window.EventBus()
          });
          
          dragHover.initWidget(widget);
          widgets.push(widget);
        }
        
        consoleOutput.innerHTML += `<div>‚úÖ –°–æ–∑–¥–∞–Ω–æ 10 –≤–∏–¥–∂–µ—Ç–æ–≤</div>`;
        
        // Check activeListeners
        const hasActiveListeners = dragHover.activeListeners instanceof WeakMap;
        consoleOutput.innerHTML += `<div>‚úÖ activeListeners is WeakMap: ${hasActiveListeners}</div>`;
        
        // Destroy all widgets
        widgets.forEach((widget, i) => {
          dragHover.destroyWidget(widget);
          widget.element.remove();
          consoleOutput.innerHTML += `<div>‚úÖ Widget ${i + 1} destroyed</div>`;
        });
        
        result.className = 'test-result success';
        result.textContent = '‚úÖ PASS: 10 –≤–∏–¥–∂–µ—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω—ã –∏ —É–¥–∞–ª–µ–Ω—ã –±–µ–∑ –æ—à–∏–±–æ–∫. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ console –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.';
        
      } catch (error) {
        result.className = 'test-result error';
        result.textContent = `‚ùå ERROR: ${error.message}`;
        consoleOutput.innerHTML += `<div class="error">${error.stack}</div>`;
      }
    }

    // Test 5: Configurable Boundary
    function testConfigurableBoundary() {
      const result = document.getElementById('test5-result');
      const consoleOutput = document.getElementById('test5-console');
      consoleOutput.style.display = 'block';
      consoleOutput.innerHTML = '';
      
      try {
        // Test default boundary
        const dragHover1 = new window.SimpleDragHover();
        consoleOutput.innerHTML += `<div>‚úÖ Default boundary offset: ${dragHover1.globalBoundaryOffset}px</div>`;
        
        // Test custom boundary
        const dragHover2 = new window.SimpleDragHover({ boundaryOffset: -100 });
        consoleOutput.innerHTML += `<div>‚úÖ Custom boundary offset: ${dragHover2.globalBoundaryOffset}px</div>`;
        
        // Test zero boundary
        const dragHover3 = new window.SimpleDragHover({ boundaryOffset: 0 });
        consoleOutput.innerHTML += `<div>‚úÖ Zero boundary offset: ${dragHover3.globalBoundaryOffset}px</div>`;
        
        const allCorrect = 
          dragHover1.globalBoundaryOffset === -60 &&
          dragHover2.globalBoundaryOffset === -100 &&
          dragHover3.globalBoundaryOffset === 0;
        
        if (allCorrect) {
          result.className = 'test-result success';
          result.textContent = '‚úÖ PASS: Boundary offset –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ';
        } else {
          result.className = 'test-result error';
          result.textContent = '‚ùå FAIL: Boundary offset –Ω–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è';
        }
        
      } catch (error) {
        result.className = 'test-result error';
        result.textContent = `‚ùå ERROR: ${error.message}`;
        consoleOutput.innerHTML += `<div class="error">${error.stack}</div>`;
      }
    }
  </script>
</body>
</html>
